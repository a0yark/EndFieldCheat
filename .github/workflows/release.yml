name: Release EndFieldCheat

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure (CMake)
        run: cmake -S . -B build -A x64

      - name: Build (Release)
        run: cmake --build build --config Release --parallel

      - name: Collect artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path artifacts -Force | Out-Null
          Get-ChildItem -Path build -Recurse -File -Include *.dll,*.pdb |
            ForEach-Object { Copy-Item $_.FullName -Destination artifacts -Force }

          if (-not (Get-ChildItem -Path artifacts -File | Select-Object -First 1)) {
            throw "No build artifacts found (.dll/.pdb)."
          }

      - name: Package artifacts
        shell: pwsh
        run: |
          $zipName = "EndFieldCheat-${{ github.ref_name }}-windows-x64.zip"
          Compress-Archive -Path artifacts\* -DestinationPath $zipName -Force
          Write-Output "ZIP_NAME=$zipName" >> $env:GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: ${{ env.ZIP_NAME }}
